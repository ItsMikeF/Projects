---
title: "titanic"
output: html_document
date: "2022-07-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Titanic - Machine Learning from Disaster**
**Analysis with regular expressions**

Load packages
```{r}
suppressMessages({
  library(tidyverse) #ggplot2, dplyr, tidyr, readr, purrr, tibble, stringr, forcats
  library(xgboost) #eXtreme Gradient Boosting Training
  library(caret) #Classification and Regression Training
  library(treemapify) #to create a tree map with ggplot2
  library(patchwork) #to combine plots
})

```

Import the data
```{r}
test <- read.csv("./data/titanic/test.csv")
train <- read.csv("./data/titanic/train.csv")
gender_submission_example <- read.csv("./data/titanic/gender_submission.csv")

str(train)
```

**1. Get the Title of People in the Name Column**
```{r}
f1 <- "(?<=,\\s)[\\w]+(?=.)"

title <- str_extract(train$Name, f1)
head(title,20)
```
The symbols in the formula above (?<=,\s)[\w]+(?=.) are:

(?<=,\s): This means that is a comma (,) and a space (" ") before our string of interest.

[\w]+: This simply means that our string of interest is a word with at least one letter.

(?=.): This signifies that there is a full stop (.) after our string of interest

Now it is time to assign our collect string to a new column in the data set.
```{r}
train$Title <- title
```

**2. Get the Cabin Letter in the Cabin Column**
```{r}
f2 <- "^\\w"

cabin <- str_extract(train$Cabin, f2)

cabin %>%
  na.omit() %>%
  head(20)
```

The formula ^\w is instructing R that we are interested in only the first letter (\w) at the beginning (^) of the string.

It is time to replace the previous values in the column with our collected value.
```{r}
train$Cabin <- cabin
```

**3. Get the Surname of Passengers from the Name Column**
```{r}
f3 <- "^\\w*(.|\\s)?(\\w*(.|\\s)?(\\w*)?)?(?=,)"

surname <- str_extract(train$Name, f3)
head(surname,20)

train$Title <- title
```
This ReGex is a bit complex as some people have spaces, hiphens, and other spaces in their surnames. Well, here's the explanation:

^\w*: we are looking for a string with letters (at least one letter)

(.|\s)?: part of our string of interest may or may not have a full stop (.) or a space (" ")

(\w(.|\s)?(\w)?)?: the string may or may not have another name (i.e. double firstname), space, and yet another name (rare occassions of a triple firstname).

(?=,): the name is proceeded by a comma (,)

Here is an easier way to get the same result:
```{r}
f4 <- ".*(=?,)"

surname2 <- str_extract(train$Name, f4)
head(surname2,20)
```
The simple explanation is that we just want to collect every letter symbol, or space that preceeds the comma (,). This simply ReGex is applicable to this dataset because the name column is well-written. However we may not be so lucky for other datasets.

It is time to assign this ReGex to a new column in our dataset
```{r}
train$Surname <- surname
```

**Wrangling (Fixing the Column Types)**
```{r}
train <- train %>%
  mutate(across(c(Survived, Pclass, Sex, Parch, Cabin, Embarked, Surname, Title), as.factor))
```

**Grouping and Visualization**
It is time to visualize our data set. However, we will first create some grouped data frames to help us explain the data set better.

**1. By Surname**
Let's start by grouping the dataset based on the "Surname" column

```{r}
grouped_surname <- train %>%
  group_by(Surname, Embarked) %>%
  summarize(Members = length(Surname), 
            Average_Fare = mean(Fare),
            Survival_Rate=round(100*mean(as.numeric(Survived == "1")),digits = 2))

head(grouped_surname)
dim(grouped_surname)
```

We added the port of embarking column (Embarked) to help us to identify and distinguish multiple families of the same surname (if any). The best column to do this would have been the "Cabin" column, but it has too many missing variables, so we have to use something else.

While we can make a chart with this dataset, it appears to have too many surnames. However, you can clearly see the rate of survival for each family. Let us filter the families so that we will only have families with at least 4 members.

```{r}
grouped_surname_filtered <- grouped_surname %>%
  dplyr::filter(Members > 3)

head(grouped_surname_filtered)
dim(grouped_surname_filtered)
```

Now that we have a smaller dataframe with only 16 unique surnames, let us create a tree map so that we can see the sizes of each family as well as their rate of survival.
```{r}
g1 <- ggplot(grouped_surname_filtered, aes(area = Members, 
                                           fill = Survival_Rate,
                                           label = paste(Surname, Members, 
                                                         sep = "\n"))) +
  geom_treemap() +
  scale_fill_gradient(low = "coral1", high = "darkturquoise") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 15) +
  ggtitle("Survival Rate of Common Families in the RMS Titanic")
g1
```

Now, let us analyze the "Title" column so that we can tell the most common titles of people in the RMS titanic ship. We will not focus on the rate of survival by title.

**2. By Title**

```{r}
grouped_title <- train %>%
  group_by(Title, Sex) %>%
  summarize(Count = length(Title))

head(grouped_title)
```

```{r}
g2 <- ggplot(grouped_title, aes(area = Count,
                                fill = Title,
                                subgroup = Sex,
                                label = paste(Title, Count, sep = "\n"))) +
  geom_treemap() +
  geom_treemap_subgroup_border(colour = "black", size = 5) +
  geom_treemap_subgroup_text(place = "centre", grow = TRUE,
                             alpha = 0.25, colour = "white",
                             fontface = "italic") +
  geom_treemap_text(colour = "black",
                    place = "centre",
                    size = 15) +
  ggtitle("RMS Titanic Passengers Grouped by Their Sex and Title")
g2
```

